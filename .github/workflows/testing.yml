name: Azure Web App Slot Deployment

on:
  push:
    branches: [main, feature/testing]
  workflow_dispatch:
    inputs:
      skip_health_check:
        description: 'Skip health check'
        required: false
        type: boolean
        default: false

env:
  # Dev/NonProd credentials
  DEV_CREDS: '{"clientId":"${{ vars.AZURE_SOF_USERNAME_NONPROD }}","clientSecret":"${{ secrets.AZURE_SOF_PASSWORD_NONPROD }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID_NONPROD }}","tenantId":"${{ vars.AZURE_SOF_TENANT_ID_NONPROD }}"}'
  # Prod credentials
  PROD_CREDS: '{"clientId":"${{ vars.AZURE_USERNAME_STG }}","clientSecret":"${{ secrets.AZURE_PASSWORD_STG }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID_STG }}","tenantId":"${{ vars.AZURE_TENANT_ID_STG }}"}'

jobs:
  build:
    name: ðŸ”¨ Packaging the App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapp-package
          path: |
            app/
            requirements.txt
            startup.sh
          retention-days: 1

  deploy-to-staging-slot:
    name: ðŸš€ Deploy to pre deployment Slot
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: webapp-package
          path: ./package

      - name: Azure login with Service Principal
        uses: azure/login@v1
        with:
          creds: ${{ github.ref_name == 'feature/testing' && env.PROD_CREDS || env.DEV_CREDS }}

      - name: Deploy to Staging Slot
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ github.ref_name == 'feature/testing' && vars.AZURE_WEBAPP_NAME_STG || vars.AZURE_WEBAPP_NAME_DEV }}
          slot-name: ${{ github.ref_name == 'feature/testing' && vars.AZURE_WEBAPP_SLOT_NAME_STG || vars.AZURE_WEBAPP_SLOT_NAME_DEV }}
          package: ./package

      - name: Logout from Azure
        run: az logout

  health-check:
    name: ðŸ¥ Slot Health Check
    runs-on: ubuntu-latest
    needs: deploy-to-staging-slot
    if: ${{ github.event.inputs.skip_health_check != 'true' }}

    steps:
      - name: Wait for application warmup
        run: sleep 120

      - name: Health Check - Staging Slot
        id: health_check
        run: |
          HEALTH_URL="${{ github.ref_name == 'feature/testing' && vars.HEALTH_CHECK_URL_PRE_STG || vars.HEALTH_CHECK_URL_PRE_DEV }}"
          echo "Checking health at: $HEALTH_URL"

          MAX_RETRIES=20
          RETRY_COUNT=0
          HEALTH_STATUS="unhealthy"

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

            echo "Attempt $((RETRY_COUNT + 1)): HTTP Status = $HTTP_STATUS"

            if [ "$HTTP_STATUS" -eq 200 ]; then
              HEALTH_STATUS="healthy"
              echo "âœ… Health check passed!"
              break
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Retrying in 15 seconds..."
              sleep 15
            fi
          done

          echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT

          if [ "$HEALTH_STATUS" != "healthy" ]; then
            echo "âŒ Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Post slot health check summary
        run: |
          echo "## ðŸ¥ Slot Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Staging URL | ${{ github.ref_name == 'feature/testing' && vars.HEALTH_CHECK_URL_PRE_STG || vars.HEALTH_CHECK_URL_PRE_DEV }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY

  manual-approval:
    name: Manual Approval Required
    runs-on: ubuntu-latest
    needs: health-check
    environment:
      name: pre-environment-approval

    steps:
      - name: Approval checkpoint
        run: |
          echo "## âœ… Manual Approval Received" >> $GITHUB_STEP_SUMMARY
          echo "Approved by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "Proceeding with slot swap..."

  slot-swap:
    name: ðŸ”„ Routing traffic to live slot
    runs-on: ubuntu-latest
    needs: manual-approval

    steps:
      - name: Azure login with Service Principal
        uses: azure/login@v1
        with:
          creds: ${{ github.ref_name == 'feature/testing' && env.PROD_CREDS || env.DEV_CREDS }}

      - name: Swap Staging to Production
        run: |
          echo "ðŸ”„ Initiating slot swap..."
          az webapp deployment slot swap \
            --resource-group ${{ github.ref_name == 'feature/testing' && vars.AZURE_RESOURCE_GROUP_STG || vars.AZURE_RESOURCE_GROUP_NON_PROD }} \
            --name ${{ github.ref_name == 'feature/testing' && vars.AZURE_WEBAPP_NAME_STG || vars.AZURE_WEBAPP_NAME_DEV }} \
            --slot ${{ github.ref_name == 'feature/testing' && vars.AZURE_WEBAPP_SLOT_NAME_STG || vars.AZURE_WEBAPP_SLOT_NAME_DEV }} \
            --target-slot production

          echo "âœ… Slot swap completed successfully!"

      - name: Verify Production Health
        run: |
          echo "Verifying production health..."
          sleep 10

          PROD_URL="${{ github.ref_name == 'feature/testing' && vars.HEALTH_CHECK_URL_STG || vars.HEALTH_CHECK_URL_DEV }}"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL" || echo "000")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Production is healthy!"
          else
            echo "âš ï¸ Production health check returned: $HTTP_STATUS"
          fi

      - name: Post deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | ${{ github.ref_name == 'feature/testing' && vars.AZURE_WEBAPP_NAME_STG || vars.AZURE_WEBAPP_NAME_DEV }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production URL | ${{ github.ref_name == 'feature/testing' && vars.HEALTH_CHECK_URL_STG || vars.HEALTH_CHECK_URL_DEV }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

      - name: Logout from Azure
        run: az logout

